<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>打卡處理中...</title>
  <style>
    body {
      background-color: #e0e0e0;
      font-size: 24px;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      flex-direction: column;
      text-align: center;
      overflow: hidden;
    }
    .star {
      position: absolute;
      width: 10px;
      height: 10px;
      background: yellow;
      border-radius: 50%;
      animation: twinkle 2s infinite;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.5); }
    }
  </style>
</head>
<body>
  <p>資料處理中，請稍候...</p>

  <script>
    // 星星動畫效果
    function createStar() {
      const star = document.createElement("div");
      star.className = "star";
      star.style.left = Math.random() * window.innerWidth + "px";
      star.style.top = Math.random() * window.innerHeight + "px";
      document.body.appendChild(star);
      setTimeout(() => document.body.removeChild(star), 2000);
    }
    setInterval(createStar, 200);

    // 取得 URL 參數
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name) || "";
    }

    const nfcid = getQueryParam("nfcid");

    // 計算距離（如果需要）
    function getDistance(lat1, lon1, lat2, lon2) {
      function toRad(d) {
        return d * Math.PI / 180;
      }
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // 定位並送出打卡資料
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      try {
        const res = await fetch("https://script.google.com/macros/s/AKfycbyXC1k0bSb6l1IaxQJkxqUsfKxVY1t7oUugwFK3K-2jf8ZJua-Yf82QgAlaYvxBK3jD4g/exec", {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({
            action: "createRecord",
            nfcid: nfcid,
            lat: lat,
            lon: lon
          })
        });

        const json = await res.json();
        const { name, time, status, errorMessage } = json;

        document.body.innerHTML = `
          <p>${errorMessage || '✅ 打卡成功！'}</p>
          <p>姓名：${name}</p>
          <p>時間：${time}</p>
          <p>狀態：${status}</p>
        `;
      } catch (err) {
        document.body.innerHTML = `<p style="color: red;">錯誤：${err.message}</p>`;
      }
    }, err => {
      document.body.innerHTML = `<p style="color: red;">無法取得定位：${err.message}</p>`;
    }, {
      enableHighAccuracy: true,
      timeout: 10000
    });
  </script>
</body>
</html>
